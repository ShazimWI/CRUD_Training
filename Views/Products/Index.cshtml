@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@

@model IEnumerable<CRUD_Training.Models.ProductModel>

@* <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" /> *@
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
@* <link href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap.min.css" rel="stylesheet" /> *@
<link rel="stylesheet" href="https://cdn.datatables.net/2.2.0/css/dataTables.bootstrap5.min.css" />

@* <div class="container"> *@
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <h5 class="card-header text-center">CRUD APPLICATION</h5>
                <div class="card-body">
                    <h2 class="card-title text-center">Add Products</h2>
                    @* <div class="justify-content-center">
                        <h5 id="message" class="badge text-bg-primary"></h5>
                    </div> *@
                    <form id="productForm" enctype="multipart/form-data" class="form-horizontal">
                        <div class="row">
                            <!-- Product Name -->
                            <div class="input-group mb-3">
                                <span class="input-group-text" for="ProductName">Product Name: </span>
                                <input class="form-control" type="text" id="ProductName" name="ProductName" required />
                            </div>
                            <br />

                            <!-- Product Price -->
                            <div class="input-group mb-3">
                                <span class="input-group-text" for="ProductPrice">Product Price: </span>
                                <input class="form-control" type="number" id="ProductPrice" name="ProductPrice" required />
                            </div>

                            <br />

                            <!-- Product Image -->
                            <div class="input-group mb-3">
                                <label class="input-group-text" for="formFile">Product Image: </label>
                                <input class="form-control" type="file" id="ProductImg" name="ProductImgFile" accept=".png, .jpg, .jpeg" required />
                            </div>

                            <br />
                            <!-- Add Button -->
                            <div class="d-flex justify-content-between">
                                <div class="col-sm-offset-4 col-sm-8">
                                    <button id="submitButton" type="button" class="btn btn-primary">Add Product</button>
                                </div>
                                <div class="justify-content-center">
                                    <h3 id="message" class="badge text-bg-dark"></h3>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
@* </div> *@

<br />

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h2>Products List</h2>

                    <table id="productsTable" class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>Product Id</th>
                                <th>Product Name</th>
                                <th>Product Price</th>
                                <th>Product Image</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dynamically add the data here by ajax-->
                        </tbody>
                        @* -----------Previous Way of Showing Data when using Server Side Request--------- *@
                        @* @foreach (var item in Model)  *@
                        @* {  *@
                        @*     <tr> *@
                        @*         <td>@item.ProductID</td>  *@
                        @*         <td>@item.ProductName</td>  *@
                        @*         <td>@item.ProductPrice</td>  *@
                        @*     </tr>  *@
                        @* } *@
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
@* <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap.min.js"></script> *@
<script src="https://cdn.datatables.net/2.2.0/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/2.2.0/js/dataTables.bootstrap5.min.js"></script>
<script src="/_framework/aspnetcore-browser-refresh.js"></script>
<script>
    //------------- ADD PRODUCT USING AJAX (CLIENT SIDE REQUEST)-------------
    $(document).ready(function (){
    
        $("#submitButton").on("click", function(e){
            e.preventDefault(); //Prevent the default form submission

            //PREVIOUSLY USING OBJECT FOR THE DATA (WHEN NO IMAGE COLUMN)
            // var productData = {
            //     ProductName: $("#ProductName").val(),
            //     ProductPrice: parseInt($("#ProductPrice").val())
            // };

            //Create a formData object
            var formData = new FormData();

            //Append the fields to the FormData object
            formData.append("ProductName", $("#ProductName").val());
            formData.append("ProductPrice", parseInt($("#ProductPrice").val()));

            
            //Append the file(image) to the FormData object
            var fileInput = $("#ProductImg")[0]; // Access the file input field
            if (fileInput.files.length > 0){
                formData.append("ProductImgFile", fileInput.files[0]); //Append the first file
            }else {
                alert("Please select an image. "); //Validate that a file is selected
                return;
            }

            //AJAX CALL
            $.ajax({
                url: "/Products/InsertProduct",
                type:"POST",

                // contentType:"application/json", //When not using FormData
                contentType: false, //Tell jQuery not to set the content type header

                // data: JSON.stringify(productData), //When not using FormData
                data: formData,

                processData: false, // Prevent jQuery from processing the FormData object

                success: function(response){
                    $("#message").html(response.message);
                    $("#productsTable").DataTable().ajax.reload(); // It refreshes the DataTable
                },
            });
        });
    });

    // --------- BINDING/INTEGRATING JQUERY DATATABLE-------------
    $(document).ready(function () {
        bindDatatable();
    });

    function bindDatatable() {
        datatable = $('#productsTable')
            .DataTable({
                //AJAX Call in the Data Table for the Refreshing and Fetching data.
                "ajax":{
                    "url": "/Products/GetProducts",
                    "type":"GET",
                    "datatype": "json"
                },
                "serverSide": false,
                "processing": true,
                "searchable": true,
                "order": [[0, 'asc']],
                "language": {
                    "emptyTable": "No record found.",
                    "processing":
                        '<i class="fa fa-spinner fa-spin fa-3x fa-fw" style="color:#2a2b2b;"></i><span class="sr-only">Loading...</span> '
                },
                "columns": [
                    {
                        "data": "productID",
                        "autoWidth": true,
                        "searchable": true
                    },
                    {
                        "data": "productName",
                        "autoWidth": true,
                        "searchable": true
                    },
                    {
                        "data": "productPrice",
                        "autoWidth": true,
                        "searchable": true
                    },
                    {
                        "data": "productImg",
                        "render": function (data) {
                            console.log(data);
                            return `<img src="${data}" alt="Product Image" style="width: 100px; height: auto;" />`;
                        }
                    }
                ]
            });
    }

     //------ THIS FUNCTION IS FOR THE FETCHING OF DATA PREVIOUSLY WHEN NOT USING JQUERY DATATABLE LIBRARY
     // function fetchData(){
     //     $(document).ready(function(){
     //        $.ajax({
     //            url: "/Products/GetProducts",
     //            type: "GET",
     //            contentType:"application/json",
     //            success: function(response){
     //                console.log(response);
     //                // first empty the existing table
     //                $("#productsTable tbody").empty();
     //                //fetching and storing data in row variable
     //                response.forEach(function(product){
     //                    var row = `
     //                        <tr>
     //                            <td>${product.productID}</td>
     //                            <td>${product.productName}</td>
     //                            <td>${product.productPrice}</td>
     //                        </tr>
     //                    `;
     //                    //appending the tbody after the data is fetched
     //                    $("#productsTable tbody").append(row);
     //                });
     //            },
     //            error: function(error){
     //                console.error("Error fetching data: ",error)
     //            }
     //        });
     //    });
     // };
     // fetchData();
</script>